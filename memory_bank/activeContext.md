# Active Context

## Current work focus

*   **Executing Phase 5: Model Training, Evaluation, and Business Simulation.**
    *   Following the detailed plan in `PLAN.md` to create the `5.0-mjv-model-training-and-evaluation.ipynb` notebook.
    *   This involves data splitting, building a preprocessing pipeline, tuning two separate XGBoost models (for precision and AUC-PR), and conducting a cost-sensitive evaluation on the holdout set.

## Recent changes

*   **Refactored data pipeline into modular scripts:**
    *   `1.0-mjv-data-ingestion-and-anonymization.py` (content from `notebooks/1.0-mjv-initial-data-exploration.ipynb`)
    *   `2.0-mjv-data-preparation.py` (placeholder created)
    *   `3.0-mjv-feature-selection-and-eda.py` (content from original `notebooks/to_be_deleted/py_version/1.0-mjv-initial-data-exploration.py`)
*   **Processed data from `3.0-mjv-feature-selection-and-eda.py` is now saved as `3.0_selected_features.parquet` for subsequent analysis. Detailed IV results for individual features are saved to `references/iv_details/` as separate CSV files.**
*   **Plots generated by `2.0-mjv-data-preparation.py` and `3.0-mjv-feature-selection-and-eda.py` are now saved to `reports/figures/`.**
*   Corrected `PROJECT_ROOT` and `project_root` definitions in `bank_fraud/config.py` and `bank_fraud/utils/data_dictionary_generator.py`.
*   Adjusted `DATA_DICTIONARIES_DIR` in `bank_fraud/config.py` to point directly to `REFERENCES_DIR`.
*   Modified Jupyter Notebook print statement for `exported_path` to show relative path.
*   Created `data_dictionary_explanation.md` for Jupyter Notebook.
*   Moved `eda_checklist.md` to `notebooks/to_be_deleted/`.
*   Updated `.cursorrules` with agent persona.
*   **Created `iv_calculation.py` in `notebooks/to_be_deleted/` for categorical IV/WoE calculation.**
*   **Created `process_binning_rules.py` in `bank_fraud/utils/` and executed it to pre-process numerical binning rules.**
*   **Generated `numerical_binning_rules_processed.csv` in `references/`.**
*   **Integrating pre-processed binning rules into the feature selection script for optimized numerical IV calculation and fixed binning issues.**
*   **Refined numerical binning definitions in `bank_fraud/utils/numerical_binning_definitions.py` for improved interpretability and consistency, including:**
    *   **Consistent 5-unit ranges for time-based features (e.g., `txn_days_active_30d`, `active_days_with_txns`).**
    *   **Discrete binning (0, 1, 2+) for occurrence counts (e.g., `change_email_occurence`, `change_mob_num_occurence`).**
    *   **Revised monetary amount bins with peso signs (e.g., `amount_INSTAPAY_IN`, `total_amount_in`, `total_amount_out`, `amount_INSTAPAY_OUT`, `amt_from_source`, `amt_to_destination`).**
    *   **Adjusted count bins (e.g., `count_INSTAPAY_IN`, `count_INSTAPAY_OUT`, `count_total_in`, `count_total_out`).**
    *   **Refined ratio/percentage bins (e.g., `repeat_counterparty_ratio_in`, `repeat_counterparty_ratio_out`, `top_source_share_in`, `top_destination_share_out`).**
    *   **Updated unique entity count bins (e.g., `num_unique_source_accounts`, `num_unique_destination_accounts`, `num_unique_destination_names`).**
    *   **Revised volatility and entropy bins (e.g., `night_txn_count`, `weekend_txn_count`, `hour_entropy`, `txn_velocity_30d`, `txn_count_day_volatility_30d`).**
*   **Created `mask_iv_details.py` in `bank_fraud/utils/` for masking sensitive IV details, and added it to `.gitignore`.**
*   **Integrated `mask_iv_details.py` into `3.0-mjv-feature-selection-and-eda.py` to automatically mask sensitive categorical data in IV details CSVs after generation.**
*   **Completed the generation of all feature distribution plots in `4.0-mjv-eda-final-features.py`, and fixed an issue where bar heights were uniform and labels were missing in the `plot_feature_distribution` function.**
*   **Implemented two-stage hyperparameter tuning (RandomizedSearchCV followed by GridSearchCV) for XGBoost models optimized for Precision and AUC-PR, with conditional saving of improved models.**

## Next steps

*   Continue with Phase 5: Implement **Step 3: Model Training, Evaluation, and Business Simulation** in the `5.0-mjv-model-training-and-evaluation.py` script.
    *   **Hyperparameter Tuning**: Completed. Two XGBoost models (one optimized for Precision, one for AUC-PR) have been tuned using a two-stage process (RandomizedSearchCV followed by GridSearchCV) and conditionally saved to the `models/` directory.
    *   **Cost-Sensitive Evaluation**: Conduct a cost-sensitive evaluation on the holdout set using the best-tuned models, incorporating a detailed two-legged business simulation (auto-blocking and analyst review queue) with specific cost assumptions.

## Known issues
*   **Conditional Hyperparameter Tuning Logic Issue**: The implemented conditional logic for skipping hyperparameter tuning (checking for existing saved models and results) is not functioning as expected; the tuning process still runs even when results are present. This needs to be investigated and fixed.

## Active decisions and considerations

*   Using a Markdown-based Memory Bank system for project context.
*   Ensuring consistent path management across the project.
*   Ensuring consistent application of the expert data scientist persona.
*   Using `nbconvert` for robust `.ipynb` file interaction.
*   **Reminder for IV Analysis:** Investigate 2815 `CONFIRMED_FRAUD` accounts with zero PESONET/INSTAPAY transactions during IV analysis to understand their fraud patterns.
*   **WoE and IV calculation for categorical features will use the `iv_calculation.py` script.**
*   **Numerical features will be binned using user-provided specific definitions before IV calculation.**
*   **Decision to pre-process numerical binning rules for optimization.**
*   **Modeling Preprocessing Strategy:** To prevent data leakage, preprocessing steps like one-hot encoding and standardization will be fitted *only* on the training data and then applied to transform the validation and holdout sets.**